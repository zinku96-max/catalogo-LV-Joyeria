<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lavi Vanessa Joyería — Catálogo</title>
  <meta name="description" content="Catálogo de oro laminado 18K — Lavi Vanessa Joyería" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  </style>
</head>
<body class="bg-amber-50 text-gray-900">
  <header class="max-w-6xl mx-auto p-4 md:p-8">
    <h1 class="text-2xl md:text-3xl font-bold">Lavi Vanessa Joyería</h1>
    <p class="text-sm text-gray-600">Catálogo · Oro laminado 18K · Donostia</p>
  </header>

  <main class="max-w-6xl mx-auto p-4 md:p-8">
    <!-- Filtros -->
    <section class="bg-white/80 rounded-2xl shadow p-4 mb-6">
      <div class="grid md:grid-cols-4 gap-3">
        <input id="searchInput" placeholder="Buscar por nombre..." class="px-3 py-2 rounded-xl border border-gray-300" />
        <select id="categoryFilter" class="px-3 py-2 rounded-xl border border-gray-300">
          <option value="">Todas las categorías</option>
        </select>
        <input id="whatsInput" placeholder="WhatsApp (ej. 34625203302)" class="px-3 py-2 rounded-xl border border-gray-300" />
        <div class="text-sm text-gray-600 flex items-center">Resultados: <b id="count" class="ml-1">0</b></div>
      </div>
    </section>

    <!-- Grid -->
    <section id="grid" class="grid sm:grid-cols-2 md:grid-cols-3 gap-4"></section>

    <p id="empty" class="hidden text-center text-gray-500 mt-8">No hay productos para mostrar.</p>
  </main>

  <footer class="max-w-6xl mx-auto p-8 text-center text-xs text-gray-500">
    © <span id="year"></span> Lavi Vanessa Joyería — Catálogo público (sin edición).
  </footer>

  <!-- Card template (sin botones de edición) -->
  <template id="cardTpl">
    <div class="bg-white rounded-2xl shadow hover:shadow-md transition overflow-hidden flex flex-col">
      <div class="p-3">
        <h3 class="font-semibold text-base line-clamp-2"></h3>
      </div>
      <div class="aspect-square bg-gray-100 overflow-hidden">
        <img class="w-full h-full object-cover" alt="Producto" />
      </div>
      <div class="p-3 flex items-center justify-between">
        <div class="text-amber-700 font-semibold"></div>
        <a target="_blank" class="whatsBtn px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm">WhatsApp</a>
      </div>
    </div>
  </template>

  <script>
    // Utilidades básicas
    const $ = s => document.querySelector(s);
    const eur = v => new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'}).format(v||0);

    const STORAGE_KEY = 'lv_catalog_products_v1';
    const PHONE_KEY = 'lv_catalog_phone';

    const state = { products: [], phone: localStorage.getItem(PHONE_KEY)||'' };

    const searchInput = $('#searchInput');
    const categoryFilter = $('#categoryFilter');
    const whatsInput = $('#whatsInput');
    const grid = $('#grid');

    // Normalización de categorías (arete/aretes, dije/dijes...)
    function normCat(c){
      if(!c) return '';
      const x = c.toString().trim().toLowerCase();
      if (x.startsWith('arete')) return 'aretes';
      if (x.startsWith('dije')) return 'dije';
      if (x.startsWith('collar')) return 'collar';
      if (x.startsWith('cadena')) return 'cadena';
      if (x.startsWith('pulsera')) return 'pulsera';
      return x;
    }

    function load(){
      document.getElementById('year').textContent = new Date().getFullYear();
      // WhatsApp desde query ?wa=
      const q = new URLSearchParams(location.search);
      const wa = (q.get('wa')||'').trim();
      if(wa){ state.phone = wa; localStorage.setItem(PHONE_KEY, wa); }
      whatsInput.value = state.phone||'';

      // 1) intentamos localStorage (por si el usuario abrió antes)
      try{ state.products = JSON.parse(localStorage.getItem(STORAGE_KEY))||[]; }catch{ state.products = []; }
      if(state.products.length>0){ render(); return; }

      // 2) si no hay, cargar catalog.json (o fallback lv_catalog_products.json)
      fetch('catalog.json').then(r=> r.ok? r.json(): Promise.reject())
        .catch(()=> fetch('lv_catalog_products.json').then(r=> r.ok? r.json(): Promise.reject()))
        .then(json=>{
          if(json && Array.isArray(json.products)){
            state.products = json.products.map(p=>({
              id: crypto.randomUUID(),
              title: p.title || p.name || '',
              price: Number(p.price || 0),
              image: p.image || '',
              category: p.category || ''
            }));
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state.products));
          }
        })
        .finally(render);
    }

    function buildCategories(){
      const set = new Map();
      state.products.forEach(p=>{
        const n = normCat(p.category);
        if(!n) return; if(!set.has(n)) set.set(n, n.charAt(0).toUpperCase()+n.slice(1));
      });
      categoryFilter.innerHTML = '<option value="">Todas las categorías</option>' +
        Array.from(set.entries()).sort((a,b)=> a[1].localeCompare(b[1]))
          .map(([val,lab])=>`<option value="${val}">${lab}</option>`).join('');
    }

    function render(){
      buildCategories();
      const term = (searchInput.value||'').toLowerCase();
      const cat = normCat(categoryFilter.value||'');

      const filtered = state.products.filter(p=>{
        const okName = !term || (p.title||'').toLowerCase().includes(term);
        const okCat = !cat || normCat(p.category)===cat;
        return okName && okCat;
      });

      $('#count').textContent = filtered.length;
      grid.innerHTML = '';
      $('#empty').classList.toggle('hidden', filtered.length>0);

      const tpl = document.getElementById('cardTpl').content.firstElementChild;
      filtered.forEach(p=>{
        const node = tpl.cloneNode(true);
        node.querySelector('h3').textContent = p.title||'';
        const img = node.querySelector('img');
        img.src = p.image || 'https://images.unsplash.com/photo-1522312346375-d1a52e2b99b3?q=80&w=600&auto=format&fit=crop';
        img.alt = p.title||'Producto';
        node.querySelector('div.text-amber-700').textContent = eur(p.price);
        const phone = (whatsInput.value||'').replace(/\D/g,'');
        const text = encodeURIComponent(`Hola, me interesa: ${p.title} (${eur(p.price)}). ¿Está disponible?`);
        node.querySelector('.whatsBtn').href = phone? `https://wa.me/${phone}?text=${text}` : `https://wa.me/?text=${text}`;
        grid.appendChild(node);
      });
    }

    // Eventos
    searchInput.addEventListener('input', render);
    categoryFilter.addEventListener('change', render);
    whatsInput.addEventListener('change', ()=>{ localStorage.setItem(PHONE_KEY, whatsInput.value.trim()); render(); });

    load();
  </script>
</body>
</html>
