<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lavi Vanessa Joyería — Catálogo</title>
  <meta name="description" content="Catálogo de oro laminado 18K — Lavi Vanessa Joyería" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  </style>
</head>
<body class="bg-amber-50 text-gray-900">
  <header class="max-w-6xl mx-auto p-4 md:p-8 flex items-center justify-between">
    <div>
      <h1 class="text-2xl md:text-3xl font-bold">Lavi Vanessa Joyería</h1>
      <p class="text-sm text-gray-600">Catálogo · Oro laminado 18K · Donostia</p>
    </div>
    <div class="flex gap-2 items-center">
      <label class="flex items-center gap-2 text-sm bg-white/80 px-3 py-2 rounded-xl border">
        <input id="adminToggle" type="checkbox" class="accent-black" />
        <span>Modo edición</span>
      </label>
      <button id="exportBtn" class="px-3 py-2 rounded-xl bg-black text-white text-sm">Exportar JSON</button>
      <label class="px-3 py-2 rounded-xl bg-gray-200 text-sm cursor-pointer">
        Importar JSON
        <input id="importInput" type="file" accept="application/json" class="hidden" />
      </label>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 md:p-8">
    <!-- Filtros -->
    <section class="bg-white/80 rounded-2xl shadow p-4 mb-6">
      <div class="grid md:grid-cols-4 gap-3">
        <input id="searchInput" placeholder="Buscar por nombre..." class="px-3 py-2 rounded-xl border border-gray-300" />
        <select id="categoryFilter" class="px-3 py-2 rounded-xl border border-gray-300">
          <option value="">Todas las categorías</option>
        </select>
        <input id="whatsInput" placeholder="WhatsApp (ej. 34625203302)" class="px-3 py-2 rounded-xl border border-gray-300" />
        <div class="text-sm text-gray-600 flex items-center">Resultados: <b id="count" class="ml-1">0</b></div>
      </div>
    </section>

    <!-- Formulario admin -->
    <section id="adminPanel" class="bg-white/80 rounded-2xl shadow p-4 mb-6 hidden">
      <h2 class="text-lg font-semibold mb-3">Añadir/editar producto</h2>
      <div class="grid md:grid-cols-5 gap-3">
        <input id="f_title" class="px-3 py-2 rounded-xl border border-gray-300" placeholder="Nombre del producto" />
        <input id="f_price" class="px-3 py-2 rounded-xl border border-gray-300" type="number" step="0.01" placeholder="Precio (€)" />
        <input id="f_image" class="px-3 py-2 rounded-xl border border-gray-300" placeholder="URL de imagen" />
        <input id="f_cat" class="px-3 py-2 rounded-xl border border-gray-300" placeholder="Categoría" />
        <button id="addBtn" class="px-4 py-2 rounded-2xl bg-black text-white">Guardar</button>
      </div>
      <p class="text-xs text-gray-500 mt-2">Sugerencia: sube fotos a Google Drive (públicas), Imgur o a tus redes y pega la URL de la imagen.</p>
    </section>

    <!-- Grid -->
    <section id="grid" class="grid sm:grid-cols-2 md:grid-cols-3 gap-4"></section>
  </main>

  <footer class="max-w-6xl mx-auto p-8 text-center text-xs text-gray-500">
    © <span id="year"></span> Lavi Vanessa Joyería — Solo catálogo (sin pagos). Contacto por WhatsApp.
  </footer>

  <template id="cardTpl">
    <div class="bg-white rounded-2xl shadow hover:shadow-md transition overflow-hidden flex flex-col">
      <div class="aspect-square bg-gray-100 overflow-hidden">
        <img class="w-full h-full object-cover" alt="Producto" />
      </div>
      <div class="p-3 flex-1 flex flex-col">
        <h3 class="font-semibold text-base line-clamp-2"></h3>
        <div class="mt-1 text-amber-700 font-semibold"></div>
        <div class="mt-3 flex gap-2 mt-auto">
          <a target="_blank" class="whatsBtn flex-1 text-center px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm">WhatsApp</a>
          <button class="editBtn px-3 py-2 rounded-xl bg-gray-200 text-sm">Editar</button>
          <button class="delBtn px-3 py-2 rounded-xl bg-red-100 text-red-700 text-sm">Borrar</button>
        </div>
      </div>
    </div>
  </template>

  <script>
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const STORAGE_KEY = 'lv_catalog_products_v1';
    const PHONE_KEY = 'lv_catalog_phone';

    const state = {
      products: [],
      phone: localStorage.getItem(PHONE_KEY) || '',
      editingId: null,
    };

    const adminToggle = $('#adminToggle');
    const adminPanel = $('#adminPanel');
    const searchInput = $('#searchInput');
    const categoryFilter = $('#categoryFilter');
    const whatsInput = $('#whatsInput');
    const addBtn = $('#addBtn');
    const exportBtn = $('#exportBtn');
    const importInput = $('#importInput');

    const f_title = $('#f_title');
    const f_price = $('#f_price');
    const f_image = $('#f_image');
    const f_cat = $('#f_cat');

    const grid = $('#grid');

    // Init
    document.getElementById('year').textContent = new Date().getFullYear();

    function load() {
      try { state.products = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { state.products = []; }
      // WhatsApp por localStorage o por query ?wa=
      const params = new URLSearchParams(location.search);
      const wa = (params.get('wa')||'').trim();
      if (wa) { state.phone = wa; localStorage.setItem(PHONE_KEY, wa); }
      whatsInput.value = state.phone || '';

      if (state.products.length === 0) {
        // Cargar catalog.json si existe en el mismo hosting
        fetch('catalog.json')
          .then(r => r.ok ? r.json() : Promise.reject(new Error('catalog.json no encontrado')))
          .then(json => {
            if (json && Array.isArray(json.products)) {
              state.products = json.products.map(p => ({ id: crypto.randomUUID(), title: p.title, price: p.price, image: p.image||'', category: p.category||'' }));
              save();
            }
          })
          .catch(()=>{})
          .finally(render);
      } else {
        render();
      }
    }

    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.products));
      if (whatsInput.value) localStorage.setItem(PHONE_KEY, whatsInput.value.trim());
    }

    function eur(v){ return new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'}).format(v||0); }

    function render() {
      // categories
      const cats = [...new Set(state.products.map(p=>p.category || ''))].filter(Boolean).sort();
      categoryFilter.innerHTML = '<option value="">Todas las categorías</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join('');

      // grid
      const q = (searchInput.value||'').toLowerCase();
      const c = categoryFilter.value||'';
      const filtered = state.products.filter(p=> (!q || (p.title||'').toLowerCase().includes(q)) && (!c || (p.category||'')===c) );
      $('#count').textContent = filtered.length;
      grid.innerHTML = '';
      filtered.forEach(p=> {
        try { grid.appendChild(card(p)); } catch(e) { /* nunca romper render */ }
      });
    }

    function card(p){
      const tpl = document.getElementById('cardTpl');
      const base = tpl && tpl.content ? tpl.content.firstElementChild : null;
      const node = base ? base.cloneNode(true) : document.createElement('div');

      const img = node.querySelector('img');
      const titleEl = node.querySelector('h3');
      const priceEl = node.querySelector('div:nth-child(2)');

      if (img) { img.src = p.image || 'https://images.unsplash.com/photo-1522312346375-d1a52e2b99b3?q=80&w=600&auto=format&fit=crop'; img.alt = p.title||'Producto'; }
      if (titleEl) titleEl.textContent = p.title || '';
      if (priceEl) priceEl.textContent = eur(p.price);

      const wa = node.querySelector('.whatsBtn');
      if (wa) { wa.href = whatsappLink(p); }
      const editBtn = node.querySelector('.editBtn');
      if (editBtn) editBtn.addEventListener('click', ()=> startEdit(p.id));
      const delBtn = node.querySelector('.delBtn');
      if (delBtn) delBtn.addEventListener('click', ()=> del(p.id));

      const tools = node.querySelectorAll('.editBtn, .delBtn');
      tools.forEach(btn => btn.classList.toggle('hidden', !adminToggle.checked));
      return node;
    }

    function whatsappLink(p){
      const phone = (whatsInput.value||'').replace(/\D/g,'');
      const text = encodeURIComponent(`Hola, me interesa: ${p.title} (${eur(p.price)}). ¿Está disponible?`);
      return phone ? `https://wa.me/${phone}?text=${text}` : `https://wa.me/?text=${text}`;
    }

    function startEdit(id){
      const p = state.products.find(x=>x.id===id);
      if(!p) return;
      state.editingId = id;
      f_title.value = p.title||''; f_price.value = p.price||''; f_image.value = p.image||''; f_cat.value = p.category||'';
      adminPanel.scrollIntoView({behavior:'smooth'});
    }

    function addOrUpdate(){
      const title = (f_title.value||'').trim();
      const price = parseFloat(f_price.value||'0');
      const image = (f_image.value||'').trim();
      const category = (f_cat.value||'').trim();
      if(!title || !(price>0)) { alert('Nombre y precio son obligatorios'); return; }

      if(state.editingId){
        const i = state.products.findIndex(x=>x.id===state.editingId);
        if(i>-1){ state.products[i] = { ...state.products[i], title, price, image, category }; }
        state.editingId = null;
      } else {
        state.products.unshift({ id: crypto.randomUUID(), title, price, image, category });
      }
      f_title.value=''; f_price.value=''; f_image.value=''; f_cat.value='';
      save(); render();
    }

    function del(id){
      if(!confirm('¿Borrar este producto?')) return;
      state.products = state.products.filter(p=>p.id!==id);
      save(); render();
    }

    // Import / Export
    exportBtn.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify({ products: state.products }, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `catalogo_lv_${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);
    });

    importInput.addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      try {
        const text = await file.text();
        const json = JSON.parse(text);
        if (json && Array.isArray(json.products)) {
          if (json.settings && json.products[0] && json.products[0].baseCost !== undefined) {
            // backup de inventario → estimar precio = coste aterrizado x2
            const iva = Number(json.settings.iva||0); const ar = Number(json.settings.arancel||0);
            state.products = json.products.map(p=>({
              id: crypto.randomUUID(),
              title: p.name || p.title,
              price: Math.round((Number(p.baseCost)*(1+ar)*(1+iva)*2)*100)/100,
              image: '',
              category: p.category || ''
            }));
          } else {
            state.products = json.products.map(p=>({ id: p.id||crypto.randomUUID(), title: p.title, price: p.price, image: p.image||'', category: p.category||'' }));
          }
          save(); render();
        } else {
          alert('JSON no reconocido. Debe contener { products: [...] }');
        }
      } catch(err){ alert('No se pudo importar: '+(err && err.message ? err.message : err)); }
      e.target.value = '';
    });

    // Events
    adminToggle.addEventListener('change', ()=>{ adminPanel.classList.toggle('hidden', !adminToggle.checked); render(); });
    addBtn.addEventListener('click', addOrUpdate);
    whatsInput.addEventListener('change', ()=>{ state.phone = whatsInput.value.trim(); save(); render(); });
    searchInput.addEventListener('input', render);
    categoryFilter.addEventListener('change', render);

    load();
  </script>
</body>
</html>
