<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Lady Vanessa Joyería ✨ — Catálogo</title>
<meta name="description" content="Catálogo de Lady Vanessa Joyería ✨ · Oro laminado 18K · Donostia">
<style>
  :root{ --bg:#fffbea; --card:#ffffff; --ink:#1b1b1b; --muted:#6b6b6b; --ring:rgba(0,0,0,.07); --dark:#111; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1100px;margin:auto;padding:24px}
  header{display:flex;gap:24px;align-items:flex-start;flex-wrap:wrap;margin-bottom:18px}
  .brand{font-weight:800;letter-spacing:.3px;font-size:clamp(26px,3.5vw,34px);line-height:1.05}
  .sub{color:var(--muted);margin-top:4px}
  .panel{background:var(--card);border-radius:14px;padding:14px 16px;box-shadow:0 6px 18px var(--ring);display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .panel input[type="search"], .panel select{border:1px solid #e7e7e7;border-radius:10px;padding:10px 12px;min-width:220px;outline:none;background:white}
  .count{color:var(--muted);font-size:14px;padding-left:4px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:14px;margin-top:16px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 8px 20px var(--ring);overflow:hidden;display:flex;flex-direction:column}
  .card h3{margin:12px 12px 0 12px;font-size:16px}
  .thumb{position:relative;aspect-ratio:1/1;background:#f6f6f6;display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:zoom-in}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .thumb.out img{filter:grayscale(1) brightness(.88)}
  .badge{position:absolute;top:10px;left:10px;background:rgba(0,0,0,.85);color:#fff;padding:6px 10px;border-radius:10px;font-size:12px}
  /* Banda diagonal para "Pulseras a mano" vendidas */
  .ribbon{position:absolute;top:14px;right:-44px;transform:rotate(45deg);background:rgba(0,0,0,.92);color:#fff;
          padding:7px 58px;font-size:12px;font-weight:700;letter-spacing:.2px;text-transform:uppercase;
          box-shadow:0 6px 14px rgba(0,0,0,.25);pointer-events:none;white-space:nowrap}
  .meta{display:flex;align-items:center;justify-content:space-between;padding:10px 12px 12px}
  .price{font-weight:700}
  .stock{color:var(--muted);font-size:12px}
  .cta{display:inline-flex;align-items:center;gap:8px;border-radius:10px;padding:9px 12px;border:1px solid #e5e5e5;background:var(--dark);color:#fff;text-decoration:none}
  .cta.secondary{background:#fff;color:#111}
  .cta[disabled]{opacity:.5;pointer-events:none;cursor:not-allowed;filter:grayscale(1)}
  footer{margin:28px 0 12px;color:var(--muted);font-size:14px}

  /* Lightbox */
  .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:9999}
  .lightbox.open{display:flex}
  .lb-inner{position:relative;max-width:100vw;max-height:100vh;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .lb-img{max-width:92vw;max-height:90vh;object-fit:contain;touch-action:none;transition:transform .15s ease}
  .lb-img.zoomed{cursor:grab}
  .lb-close{position:absolute;top:14px;right:14px;border:none;border-radius:999px;background:rgba(255,255,255,.15);color:#fff;width:40px;height:40px;font-size:22px;line-height:40px;text-align:center;cursor:pointer}
  .lb-title{position:absolute;left:16px;bottom:16px;color:#fff;font-size:14px;background:rgba(0,0,0,.35);padding:6px 10px;border-radius:8px;max-width:80vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="brand">Lady Vanessa Joyería ✨</div>
        <div class="sub">Catálogo · Oro laminado 18K · Donostia <span class="pill" id="catBadge">Público</span></div>
      </div>
    </header>

    <section class="panel" role="search">
      <input id="q" type="search" placeholder="Buscar por nombre…">
      <select id="cat"><option value="*">Todas las categorías</option></select>
      <div class="count" id="count">Resultados: 0</div>
    </section>

    <section class="grid" id="grid" aria-live="polite"></section>

    <footer>© <span id="yr"></span> Lady Vanessa Joyería ✨ — Solo catálogo (sin pagos). Contacto por WhatsApp.</footer>
  </div>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" aria-hidden="true" role="dialog" aria-label="Vista ampliada de la imagen">
    <div class="lb-inner">
      <button class="lb-close" aria-label="Cerrar">✕</button>
      <img id="lbimg" class="lb-img" alt="">
      <div id="lbtitle" class="lb-title"></div>
    </div>
  </div>

<script>
/* v4.8.2 — Banda diagonal para Pulseras a mano (Vendido, pide la tuya) + Agotado resto + Drive/proxy fallback */
(function(){
  document.getElementById('yr').textContent = new Date().getFullYear();
  const EUR = new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'});

  // ---- Drive + Proxy helpers ----
  function driveIdFromUrl(u){
    try{
      if(u.includes("/file/d/")) return u.split("/d/")[1].split("/")[0];
      const url = new URL(u); const id = url.searchParams.get("id"); if(id) return id;
    }catch(e){}
    return null;
  }
  function toProxy(u){
    try{
      const noScheme = u.replace(/^https?:\/\//,'');
      return 'https://images.weserv.nl/?url=' + encodeURIComponent(noScheme) + '&w=1200&n=-1';
    }catch(e){ return u; }
  }
  function imageCandidates(u){
    if(!u) return [];
    const id = driveIdFromUrl(u);
    if(id){ return [
      `https://drive.google.com/uc?export=view&id=${id}`,
      `https://drive.google.com/thumbnail?id=${id}&sz=w1600`,
      u,
      toProxy(u)
    ]; }
    return [u, toProxy(u)];
  }
  function setImageWithFallback(img, url){
    const PLACEHOLDER = 'https://images.unsplash.com/photo-1522312346375-d1a52e2b99b3?q=80&w=1200&auto=format&fit=crop';
    const cands = imageCandidates(url); let i=0;
    function next(){ if(i<cands.length){ img.src=cands[i++]; } else { img.src=PLACEHOLDER; } }
    img.onerror = next; next();
  }

  // ---- Categorías (con "Pulseras a mano") ----
  function normalizeCategory(c){
    c = (c||'').toString().trim().toLowerCase();
    if(!c) return 'otros';
    if(c.startsWith('pulseras a mano')) return 'pulseras a mano';
    if(c.startsWith('arete')) return 'aretes';
    if(c.startsWith('cadena')) return 'cadena';
    if(c.startsWith('collar')) return 'collar';
    if(c.startsWith('dije') || c.includes('charm') || c.includes('colgante')) return 'dije';
    if(c.startsWith('pulsera')) return 'pulsera';
    return c;
  }
  function titleCase(s){ return s ? s[0].toUpperCase()+s.slice(1) : s; }
  function sortCatsWithPriority(arr){
    const prio = (c)=> c==='pulseras a mano' ? 0 : 1;
    return arr.sort((a,b)=> (prio(a)-prio(b)) || a.localeCompare(b,'es'));
  }

  // ---- Datos ----
  const PREFERRED = ['lv_catalog_products.json','catalog.json'];
  async function fetchFresh(url){
    const res = await fetch(url + (url.includes('?')?'&':'?') + 't=' + Date.now(), {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status+' al pedir '+url);
    return res.json();
  }
  async function loadData(){
    for(const p of PREFERRED){
      try{ return await fetchFresh(p); }catch(e){}
    }
    throw new Error('No se pudo cargar el catálogo.');
  }

  // ---- UI refs ----
  const $grid = document.getElementById('grid');
  const $q = document.getElementById('q');
  const $cat = document.getElementById('cat');
  const $count = document.getElementById('count');

  // ---- Lightbox ----
  const $lb = document.getElementById('lightbox');
  const $lbimg = document.getElementById('lbimg');
  const $lbtitle = document.getElementById('lbtitle');
  const $lbclose = document.querySelector('.lb-close');
  let zoomed=false,startX=0,startY=0,imgX=0,imgY=0,lastTap=0;

  function openLightbox(url, title){
    $lbtitle.textContent = title || '';
    $lbimg.style.transform='translate(0px,0px) scale(1)';
    imgX=imgY=0; zoomed=false; $lbimg.classList.remove('zoomed');
    setImageWithFallback($lbimg, url);
    $lb.classList.add('open'); $lb.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden';
  }
  function closeLightbox(){ $lb.classList.remove('open'); $lb.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
  function onPointerDown(e){ if(!zoomed)return; const pt=e.touches?e.touches[0]:e; startX=pt.clientX-imgX; startY=pt.clientY-imgY; $lbimg.style.cursor='grabbing'; }
  function onPointerMove(e){ if(!zoomed)return; if(!(e.buttons===1||(e.touches&&e.touches.length)))return; const pt=e.touches?e.touches[0]:e; imgX=pt.clientX-startX; imgY=pt.clientY-startY; $lbimg.style.transform=`translate(${imgX}px, ${imgY}px) scale(2)`; }
  function onPointerUp(){ $lbimg.style.cursor='grab'; }
  function onTap(e){ const now=Date.now(); if(now-lastTap<300){ zoomed=!zoomed; if(zoomed){ $lbimg.classList.add('zoomed'); $lbimg.style.transform='translate(0px,0px) scale(2)'; imgX=imgY=0; } else { $lbimg.classList.remove('zoomed'); $lbimg.style.transform='translate(0px,0px) scale(1)'; } e.preventDefault(); } lastTap=now; }
  $lb.addEventListener('click', (e)=>{ if(e.target===$lb) closeLightbox(); });
  $lbclose.addEventListener('click', closeLightbox);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeLightbox(); });
  $lbimg.addEventListener('mousedown', onPointerDown);
  document.addEventListener('mousemove', onPointerMove);
  document.addEventListener('mouseup', onPointerUp);
  $lbimg.addEventListener('touchstart', onPointerDown,{passive:true});
  $lbimg.addEventListener('touchmove', onPointerMove,{passive:false});
  $lbimg.addEventListener('touchend', onPointerUp,{passive:true});
  $lbimg.addEventListener('click', onTap);

  // ---- Render ----
  function productNode(p){
    const cat = normalizeCategory(p.category);
    const out = (Number.isFinite(p.stock) && p.stock<=0);
    const node = document.createElement('article');
    node.className = 'card';
    node.innerHTML = `
      <h3 title="${p.title.replace(/"/g,'&quot;')}">${p.title}</h3>
      <div class="thumb ${out?'out':''}">
        <img alt="${p.title}">
        ${out
          ? (cat==='pulseras a mano'
              ? '<div class="ribbon">Vendido, pide la tuya</div>'
              : '<span class="badge">Agotado</span>')
          : ''}
      </div>
      <div class="meta">
        <div>
          <div class="price">${EUR.format(p.price||0)}</div>
          ${Number.isFinite(p.stock) ? `<div class="stock">Stock: ${p.stock}</div>`:''}
        </div>
        <button class="cta secondary" ${out?'disabled':''} aria-label="Copiar info"><span>Copiar info</span></button>
      </div>`;
    const img = node.querySelector('img');
    setImageWithFallback(img, p.image);
    node.querySelector('.thumb').addEventListener('click',(ev)=>{ ev.preventDefault(); const big=(imageCandidates(p.image)[0]||p.image||img.src); openLightbox(big, p.title); });
    const btn = node.querySelector('.cta');
    btn.addEventListener('click',(e)=>{ e.preventDefault(); const txt=`${p.title} — ${EUR.format(p.price||0)}`; navigator.clipboard?.writeText(txt); btn.innerHTML='Copiado ✓'; setTimeout(()=>{ btn.innerHTML='Copiar info'; },1200); });
    return node;
  }

  function buildCategories(items){
    const set = new Set();
    items.forEach(p=> set.add(normalizeCategory(p.category)));
    const arr = (function sortCats(arr){
      const prio = c=> c==='pulseras a mano' ? 0 : 1;
      return arr.sort((a,b)=> (prio(a)-prio(b)) || a.localeCompare(b,'es'));
    })(Array.from(set).filter(Boolean));
    const current = $cat.value || '*';
    $cat.innerHTML = '<option value="*">Todas las categorías</option>' +
      arr.map(c=>`<option value="${c}">${c[0].toUpperCase()+c.slice(1)}</option>`).join('');
    $cat.value = current;
  }

  function applyFilters(items){
    const term = $q.value.trim().toLowerCase();
    const catv = $cat.value;
    return items.filter(p=>{
      const okName = !term || (p.title||'').toLowerCase().includes(term);
      const okCat = (catv==='*') || normalizeCategory(p.category)===catv;
      return okName && okCat;
    });
  }

  function render(items){
    buildCategories(items);
    const filtered = applyFilters(items);
    $grid.innerHTML=''; filtered.forEach(p=> $grid.appendChild(productNode(p)));
    $count.textContent = `Resultados: ${filtered.length}`;
  }

  loadData().then(data=>{
    let items = (data.products||[]).map(p=>({
      title: p.title || p.name || 'Producto',
      price: Number(p.price||0),
      image: p.image || '',
      category: normalizeCategory(p.category || p.categoryName || 'otros'),
      visible: (p.visible !== false),
      stock: (p.stock===0 ? 0 : (Number.isFinite(+p.stock)? +p.stock : null))
    }));
    items = items.filter(p=> p.visible);
    render(items);
    $q.addEventListener('input', ()=> render(items));
    $cat.addEventListener('change', ()=> render(items));
  })
  .catch(err=>{
    document.getElementById('grid').innerHTML =
      `<div style="padding:14px">No se pudo cargar el catálogo. Sube <code>lv_catalog_products.json</code> o <code>catalog.json</code> a la raíz del repositorio.</div>`;
    console.error(err);
  });
})();
</script>
</body>
</html>
