<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Editor de Cat√°logo ‚Äî Lady Vanessa Joyer√≠a ‚ú® (v1.3)</title>
<meta name="description" content="Editor visual para lv_catalog_products.json">
<style>
  :root{ --bg:#fffbea; --card:#fff; --ink:#1b1b1b; --muted:#6b6b6b; --ring:rgba(0,0,0,.07); --accent:#111; --warn:#b00020; --ok:#008a2a; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{max-width:1200px;margin:20px auto 12px;padding:0 16px;display:flex;gap:12px;align-items:baseline;justify-content:space-between;flex-wrap:wrap}
  h1{font-size:22px;margin:0}
  .wrap{max-width:1200px;margin:auto;padding:0 16px 24px}
  .panel{background:var(--card);border-radius:14px;padding:14px 16px;box-shadow:0 6px 18px var(--ring);display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px}
  .panel input[type="text"], .panel input[type="url"], .panel input[type="number"], .panel select, .panel textarea{
    border:1px solid #e7e7e7;border-radius:10px;padding:10px 12px;background:#fff;outline:none
  }
  .btn{appearance:none;border:1px solid #e5e5e5;border-radius:10px;padding:9px 12px;background:#111;color:#fff;cursor:pointer}
  .btn.secondary{background:#fff;color:#111}
  .btn.warn{background:var(--warn);color:#fff;border-color:var(--warn)}
  .btn.ok{background:var(--ok);color:#fff;border-color:var(--ok)}
  .grid{overflow:auto;border-radius:14px;border:1px solid #eee;background:#fff}
  table{width:100%;min-width:1400px;border-collapse:collapse;font-size:14px}
  th, td{padding:10px;border-bottom:1px solid #f0f0f0;vertical-align:top;white-space:nowrap}
  th{position:sticky;top:0;background:#fafafa;z-index:2}
  tbody tr:hover{background:#fffdf0}
  .imgprev{width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid #eee;background:#f7f7f7}
  .imgprev.bad{outline: 2px solid #ff9b9b}
  .row-actions{display:flex;gap:6px}
  .pill{display:inline-block;background:#111;color:#fff;border-radius:999px;padding:2px 8px;font-size:12px}
  .muted{color:var(--muted)}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .error{background:#fff3f3;border:1px solid #ffd2d2;color:#8a0000;border-radius:12px;padding:12px;margin:12px 0;display:none}
  .ok{background:#f1fff3;border:1px solid #c7ffd2;color:#008a2a;border-radius:12px;padding:12px;margin:12px 0;display:none}
  @media (max-width:840px){ .two{grid-template-columns:1fr} th:nth-child(6), td:nth-child(6){min-width:220px} }
  .tiny{font-size:12px;color:#999}
</style>
</head>
<body>
<header>
  <h1>Editor de Cat√°logo ‚Äî Lady Vanessa Joyer√≠a ‚ú® <span class="tiny">(v1.3)</span></h1>
  <div><span class="pill">Admin local</span> <span class="muted">Edita y descarga el JSON</span></div>
</header>

<div class="wrap">

  <div class="panel">
    <button class="btn" id="loadSame">Cargar del repo</button>
    <label class="btn secondary" for="file">Importar archivo‚Ä¶</label>
    <input id="file" type="file" accept="application/json" style="display:none">
    <input id="jsonUrl" type="url" placeholder="o URL completa del JSON (opcional)" style="min-width:280px">
    <button class="btn secondary" id="loadUrl">Cargar URL</button>
    <div class="muted" id="status">Sin datos</div>
  </div>

  <div class="panel">
    <input id="search" type="text" placeholder="Buscar‚Ä¶">
    <select id="filterCat"><option value="*">Todas las categor√≠as</option></select>
    <label class="muted"><input id="showHidden" type="checkbox"> Mostrar ocultos</label>
    <select id="defaultCat">
      <option value="pulseras a mano" selected>Pulseras a mano</option>
      <option value="aretes">Aretes</option>
      <option value="dije">Dije</option>
      <option value="cadena">Cadena</option>
      <option value="pulsera">Pulsera</option>
      <option value="collar">Collar</option>
      <option value="otros">Otros</option>
    </select>
    <button class="btn" id="add">A√±adir producto (cat. por defecto)</button>
    <button class="btn secondary" id="export">Descargar JSON (con fecha)</button>
    <button class="btn secondary" id="convertDrive">ü™Ñ Arreglar todos los links de Drive</button>
  </div>

  <div class="panel">
    <strong>Venta r√°pida</strong>
    <select id="quickProduct" style="min-width:260px"></select>
    <input id="quickQty" type="number" step="1" min="1" value="1" style="width:100px">
    <label class="muted"><input id="autoHideZero" type="checkbox"> Ocultar si stock llega a 0</label>
    <button class="btn ok" id="doSell">Vender (restar stock)</button>
    <div class="muted" id="sellMsg"></div>
  </div>

  <div class="grid">
    <table id="table">
      <thead>
        <tr>
          <th>#</th>
          <th>SKU/ID</th>
          <th>Visible</th>
          <th>Foto</th>
          <th>T√≠tulo</th>
          <th>Imagen (URL)</th>
          <th>Precio (‚Ç¨)</th>
          <th>Categor√≠a</th>
          <th>Stock</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="two" style="margin-top:12px">
    <div class="panel" style="align-items:stretch">
      <div style="flex:1">
        <h3 style="margin:0 0 8px 0">Actualizar precios en bloque</h3>
        <p class="muted" style="margin:0 0 8px 0">Pega <b>T√≠tulo<TAB>Precio</b>, una l√≠nea por producto.</p>
        <textarea id="bulk" rows="8" placeholder="Ejemplo:
23275 - D MANO DE FATIMA\t15
34198 - CANDONGA GUCCI\t21" style="width:100%"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="applyBulk">Aplicar precios</button>
        </div>
        <div id="bulkResult" class="ok"></div>
      </div>
    </div>
    <div>
      <div id="errorBox" class="error"></div>
      <div id="okBox" class="ok"></div>
    </div>
  </div>

</div>

<script>
// ---------- Utilidades ----------
function normalizeCategory(c){
  c = (c||'').toString().trim().toLowerCase();
  if(!c) return 'otros';
  if(c.startsWith('pulseras a mano')) return 'pulseras a mano';
  if(c.startsWith('arete')) return 'aretes';
  if(c.startsWith('cadena')) return 'cadena';
  if(c.startsWith('collar')) return 'collar';
  if(c.startsWith('dije') || c.includes('charm') || c.includes('colgante')) return 'dije';
  if(c.startsWith('pulsera')) return 'pulsera';
  return c;
}

// Drive + fallback (igual que el cat√°logo p√∫blico)
function driveIdFromUrl(u){
  try{
    if(u.includes('/file/d/')) return u.split('/d/')[1].split('/')[0];
    const url = new URL(u); const id = url.searchParams.get('id'); if(id) return id;
  }catch(e){}
  return null;
}
function imageCandidates(u){
  if(!u) return [];
  const id = driveIdFromUrl(u);
  if(id){
    return [
      `https://drive.google.com/uc?export=view&id=${id}`,
      `https://drive.google.com/thumbnail?id=${id}&sz=w1600`,
      u
    ];
  }
  return [u];
}
function setImageWithFallback(img, url){
  const PLACEHOLDER = 'https://images.unsplash.com/photo-1522312346375-d1a52e2b99b3?q=80&w=1200&auto=format&fit=crop';
  const cands = imageCandidates(url);
  let i=0;
  function next(){ if(i<cands.length){ img.src=cands[i++]; } else { img.src=PLACEHOLDER; } }
  img.onerror = ()=>{ img.classList.add('bad'); next(); };
  img.onload  = ()=>{ img.classList.remove('bad'); };
  next();
}
function csvParsePrices(txt){
  const map = new Map();
  txt.split(/\r?\n/).forEach(ln => {
    const s = ln.trim(); if(!s) return;
    const parts = s.split(/\t+/);
    if(parts.length >= 2){
      const title = parts[0].trim();
      const price = parseFloat(String(parts[1]).replace(',','.'));
      if(!isNaN(price)) map.set(title.toUpperCase(), price);
    } else {
      const m = s.match(/^(.*\S)\s+(\d+(?:[.,]\d+)?)$/);
      if(m){
        const title = m[1].trim();
        const price = parseFloat(m[2].replace(',','.'));
        if(!isNaN(price)) map.set(title.toUpperCase(), price);
      }
    }
  });
  return map;
}
function tsName(){
  const d=new Date();
  const pad=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
}

// ---------- Estado ----------
let products = [];
let dirty = false;

// ---------- Carga ----------
const statusEl = document.getElementById('status');
async function fetchFresh(url){
  const res = await fetch(url + (url.includes('?')?'&':'?') + 't=' + Date.now(), {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status+' al pedir '+url);
  return res.json();
}
async function loadFromRepo(){
  errorBox(''); okBox('');
  const candidates = ['lv_catalog_products.json','catalog.json'];
  let lastErr = '';
  for(const c of candidates){
    try{
      const data = await fetchFresh(c);
      if(data && Array.isArray(data.products)){ products = data.products; rebuild(); okBox('Cargado: '+c); return; }
    }catch(e){ lastErr = e.message || String(e); }
  }
  errorBox('No se pudo cargar del repo. Intent√©: '+candidates.join(' ‚Üí ') + (lastErr? ' ¬∑ '+lastErr:''));
}
async function loadFromUrl(url){
  errorBox(''); okBox('');
  try{
    const data = await fetchFresh(url);
    if(data && Array.isArray(data.products)){ products = data.products; rebuild(); okBox('Cargado desde URL.'); }
    else throw new Error('Estructura inv√°lida (debe contener "products")');
  }catch(e){ errorBox('Error al cargar URL: '+(e.message||e)); }
}
function loadFromFile(file){
  errorBox(''); okBox('');
  const fr = new FileReader();
  fr.onload = () => {
    try{
      const data = JSON.parse(fr.result);
      if(data && Array.isArray(data.products)){ products = data.products; rebuild(); okBox('Archivo importado.'); }
      else throw new Error('Estructura inv√°lida (debe contener "products")');
    }catch(e){ errorBox('Error al leer archivo: '+(e.message||e)); }
  };
  fr.readAsText(file, 'utf-8');
}

// ---------- Render ----------
const tbody = document.querySelector('#table tbody');
const filterCat = document.getElementById('filterCat');
const inputSearch = document.getElementById('search');
const showHidden = document.getElementById('showHidden');
const quickProduct = document.getElementById('quickProduct');
const defaultCat = document.getElementById('defaultCat');

function rebuild(){
  products.forEach(p=>{ if(p.visible === undefined) p.visible = true; if(p.stock === undefined) p.stock = 0; });
  // categor√≠as presentes + predefinidas
  const set = new Set(['pulseras a mano','aretes','dije','cadena','pulsera','collar','otros']);
  products.forEach(p=> set.add(normalizeCategory(p.category)));
  const arr = Array.from(set).filter(Boolean).sort((a,b)=>a.localeCompare(b,'es'));
  filterCat.innerHTML = '<option value="*">Todas las categor√≠as</option>' + arr.map(c=>`<option value="${c}">${c[0].toUpperCase()+c.slice(1)}</option>`).join('');
  // select de nueva categor√≠a por defecto
  const current = defaultCat.value || 'pulseras a mano';
  defaultCat.innerHTML = arr.map(c=>`<option value="${c}" ${c===current?'selected':''}>${c[0].toUpperCase()+c.slice(1)}</option>`).join('');
  // venta r√°pida select
  quickProduct.innerHTML = products.map((p,i)=>`<option value="${i}">${p.title || 'Producto'}${p.sku ? ' ['+p.sku+']':''}</option>`).join('');
  render();
}

function render(){
  const term = (inputSearch.value||'').trim().toLowerCase();
  const catv = filterCat.value;
  const rows = products
    .map((p, i) => ({...p, index:i}))
    .filter(p => (showHidden.checked || p.visible !== false))
    .filter(p => !term || (p.title||'').toLowerCase().includes(term) || (String(p.sku||'').toLowerCase().includes(term)))
    .filter(p => (catv === '*' || normalizeCategory(p.category) === catv));

  tbody.innerHTML = '';
  rows.forEach(row => tbody.appendChild(rowNode(row)));
  statusEl.textContent = `Mostrando ${rows.length} de ${products.length}`;
}

function rowNode(p){
  const tr = document.createElement('tr');

  const tdIdx = document.createElement('td'); tdIdx.textContent = String(p.index+1); tr.appendChild(tdIdx);

  const tdSku = document.createElement('td');
  const sku = document.createElement('input'); sku.type='text'; sku.value = p.sku || ''; sku.style.width='120px';
  sku.addEventListener('input', ()=>{ products[p.index].sku = sku.value; dirty=true; });
  tdSku.appendChild(sku); tr.appendChild(tdSku);

  const tdVis = document.createElement('td');
  const vis = document.createElement('input'); vis.type='checkbox'; vis.checked = (p.visible !== false);
  vis.addEventListener('change', ()=>{ products[p.index].visible = vis.checked; dirty=true; });
  tdVis.appendChild(vis); tr.appendChild(tdVis);

  const tdPrev = document.createElement('td');
  const img = document.createElement('img'); img.className='imgprev'; img.alt=p.title||'';
  setImageWithFallback(img, p.image || '');
  tdPrev.appendChild(img); tr.appendChild(tdPrev);

  const tdTitle = document.createElement('td');
  const t = document.createElement('input'); t.type='text'; t.value = p.title || p.name || ''; t.style.minWidth='220px';
  t.addEventListener('input', ()=>{ products[p.index].title = t.value; dirty=true; });
  tdTitle.appendChild(t); tr.appendChild(tdTitle);

  const tdUrl = document.createElement('td');
  const u = document.createElement('input'); u.type='url'; u.value = p.image || ''; u.placeholder='https://...'; u.style.minWidth='360px';
  const fix = document.createElement('button'); fix.className='btn secondary'; fix.textContent='ü™Ñ Drive';
  fix.addEventListener('click', ()=>{ u.value = imageCandidates(u.value)[0] || u.value; u.dispatchEvent(new Event('input')); });
  u.addEventListener('input', ()=>{ products[p.index].image = u.value; setImageWithFallback(img, u.value); dirty=true; });
  const open = document.createElement('a'); open.href = p.image || '#'; open.target='_blank'; open.textContent='‚Üó'; open.style.marginLeft='6px';
  u.addEventListener('input', ()=>{ open.href = u.value || '#'; });
  tdUrl.appendChild(u); tdUrl.appendChild(fix); tdUrl.appendChild(open);
  tr.appendChild(tdUrl);

  const tdPrice = document.createElement('td');
  const pr = document.createElement('input'); pr.type='number'; pr.step='0.01'; pr.min='0'; pr.value = (p.price!=null? p.price : ''); pr.style.width='120px';
  pr.addEventListener('input', ()=>{ products[p.index].price = parseFloat(pr.value)||0; dirty=true; });
  tdPrice.appendChild(pr); tr.appendChild(tdPrice);

  const tdCat = document.createElement('td');
  const c = document.createElement('input'); c.type='text'; c.value = p.category || defaultCat.value || 'pulseras a mano';
  c.placeholder='aretes, cadena, dije, pulsera, collar, pulseras a mano'; c.style.width='200px';
  c.addEventListener('input', ()=>{ products[p.index].category = c.value; dirty=true; });
  tdCat.appendChild(c); tr.appendChild(tdCat);

  const tdStock = document.createElement('td');
  const st = document.createElement('input'); st.type='number'; st.step='1'; st.min='0'; st.value = (p.stock!=null? p.stock : ''); st.style.width='90px';
  st.addEventListener('input', ()=>{ const v = parseInt(st.value,10); products[p.index].stock = isNaN(v)? 0: v; dirty=true; });
  tdStock.appendChild(st); tr.appendChild(tdStock);

  const tdAc = document.createElement('td'); tdAc.className='row-actions';
  const dup = document.createElement('button'); dup.className='btn secondary'; dup.textContent='Duplicar';
  dup.addEventListener('click', ()=>{ const copy = JSON.parse(JSON.stringify(products[p.index])); copy.title = (copy.title||'Producto') + ' (copia)'; products.splice(p.index+1,0,copy); rebuild(); dirty=true; });
  const del = document.createElement('button'); del.className='btn warn'; del.textContent='Borrar';
  del.addEventListener('click', ()=>{ if(confirm('¬øBorrar este producto?')){ products.splice(p.index,1); rebuild(); dirty=true; } });
  const up = document.createElement('button'); up.className='btn secondary'; up.textContent='‚Üë'; up.title='Subir';
  up.addEventListener('click', ()=>{ if(p.index>0){ const tmp=products[p.index-1]; products[p.index-1]=products[p.index]; products[p.index]=tmp; rebuild(); dirty=true; } });
  const dn = document.createElement('button'); dn.className='btn secondary'; dn.textContent='‚Üì'; dn.title='Bajar';
  dn.addEventListener('click', ()=>{ if(p.index<products.length-1){ const tmp=products[p.index+1]; products[p.index+1]=products[p.index]; products[p.index]=tmp; rebuild(); dirty=true; } });
  tdAc.appendChild(dup); tdAc.appendChild(up); tdAc.appendChild(dn); tdAc.appendChild(del); tr.appendChild(tdAc);

  return tr;
}

// ---------- Acciones ----------
function errorBox(msg){ const el=document.getElementById('errorBox'); el.textContent=msg||''; el.style.display = msg? 'block':'none'; }
function okBox(msg){ const el=document.getElementById('okBox'); el.textContent=msg||''; el.style.display = msg? 'block':'none'; }

document.getElementById('loadSame').addEventListener('click', loadFromRepo);
document.getElementById('file').addEventListener('change', e=>{ const f=e.target.files[0]; if(f) loadFromFile(f); });
document.getElementById('loadUrl').addEventListener('click', ()=>{
  const u = document.getElementById('jsonUrl').value.trim(); if(u) loadFromUrl(u);
});

document.getElementById('add').addEventListener('click', ()=>{
  const cat = (defaultCat.value || 'pulseras a mano').toLowerCase();
  products.push({ sku:'', title:'Nuevo producto', price:0, image:'', category:cat, visible:true, stock:0 });
  rebuild(); dirty=true;
});

document.getElementById('export').addEventListener('click', ()=>{
  const out = { products };
  const blob = new Blob([JSON.stringify(out, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'lv_catalog_products_' + tsName() + '.json';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
  okBox('Descargado JSON con fecha.');
  dirty=false;
});

document.getElementById('search').addEventListener('input', render);
document.getElementById('filterCat').addEventListener('change', render);
document.getElementById('showHidden').addEventListener('change', render);

document.getElementById('convertDrive').addEventListener('click', ()=>{
  let changes=0;
  products.forEach(p=>{
    const cand = imageCandidates(p.image||'');
    const conv = cand[0] || p.image;
    if(conv && conv !== p.image){ p.image = conv; changes++; }
  });
  rebuild();
  okBox(`Convertidos ${changes} enlaces de Drive a vista directa.`);
  dirty = dirty || (changes>0);
});

// Venta r√°pida
document.getElementById('doSell').addEventListener('click', ()=>{
  const idx = parseInt(quickProduct.value,10);
  const qty = parseInt(document.getElementById('quickQty').value,10) || 1;
  const autoHide = document.getElementById('autoHideZero').checked;
  if(isNaN(idx) || idx<0 || idx>=products.length) return;
  const p = products[idx];
  const old = parseInt(p.stock||0,10);
  const newStock = Math.max(0, old - qty);
  p.stock = newStock;
  if(autoHide && newStock===0) p.visible = false;
  rebuild();
  const msg = document.getElementById('sellMsg');
  msg.textContent = `OK: "${p.title}" stock ${old} ‚Üí ${newStock}` + (autoHide && newStock===0 ? ' (ocultado)':'');
  setTimeout(()=>{ msg.textContent=''; }, 2500);
  dirty = true;
});

// Intento de carga al abrir
loadFromRepo().catch(()=>{});
</script>
</body>
</html>
